@{
    ViewBag.Title = "InsertPlan";
    Layout = null;
}

<link href="~/Content/Styles/learunui-framework.css" rel="stylesheet" />
<link href="~/Content/Styles/learunui-accordion.css" rel="stylesheet" />
<script src="~/Content/Scripts/jquery/jquery-1.8.2.min.js"></script>
<script src="~/Content/Scripts/learunui-framework.js"></script>
<link href="~/Content/Styles/buttons.css" rel="stylesheet" />
<script src="~/Content/Scripts/datepicker/WdatePicker.js"></script>
<link href="~/Content/Scripts/SearchableSelect/jquery.searchableSelect.css" rel="stylesheet" />
<script src="~/Content/Scripts/SearchableSelect/jquery.searchableSelect.js"></script>
<link href="~/Content/Scripts/jquery.layer/theme/default/layer.css" rel="stylesheet" />
<script src="~/Content/Scripts/jquery.layer/layer.js"></script>

<link href="~/Content/Scripts/jquery.select2/css/select2.css" rel="stylesheet" />
<script src="~/Content/Scripts/jquery.select2/js/select2.js"></script>

<style>
    #grid td {
        text-align: left;
        border-bottom: 1px solid #ccc;
        padding: 6px 2px;
    }

    #divFileName {
        width: 310px;
        white-space: nowrap;
        text-overflow: ellipsis;
        -o-text-overflow: ellipsis;
        overflow: hidden;
    }

    #grid td img {
        vertical-align: middle;
        border: 0px solid #fff;
    }

    .uploadify-queue {
        margin-top: 6px;
    }

    .uploadify-queue-item {
        width: 468px;
        padding-top: 8px;
        padding-bottom: 7px;
        margin-top: 0px;
        border-top: none;
    }

        .uploadify-queue-item .cancel a {
            display: none;
        }

    input {
        background: #E0FFFF;
    }

    textarea {
        background: #E0FFFF;
    }

    select {
        background: #E0FFFF;
    }
</style>

<table align=center valign=middle>
    <tr>
        <td>问题责任人<font color="red">*</font></td>
        <td>
            <select id="ResponseBy" class="txtselect" onchange="CheckIsManger()"></select>
        </td>
    </tr>
    <tr>
        <td>问题描述 <font color="red">*</font></td>
        <td>
            <input id="Descripe" type="text" class="txt" />
        </td>
    </tr>
    <tr>
        <td>对应措施 </td>
        <td>
            <input placeholder="可不填！由责任人填写" id="Action" type="text" class="txt" />
        </td>
    </tr>
    <tr>
        <td>计划完成时间 <font color="red">*</font></td>
        <td>
            <input id="PlanDate" type="text" class="txt Wdate" onfocus="WdatePicker()" style="background:#E0FFFF;" />
        </td>
    </tr>
    <tr>
        <td>重大问题列入快速反应</td>
        <td>
            <select id="IsRapid" class="txtselect">
                <option value="否">否</option>
                <option value="是">是</option>
            </select>
        </td>
    </tr>
</table>

<div align=center valign=middle>
    <button class="button button-primary button-square button-small" onclick="cancel()">取消</button>
    <button class="button button-primary button-square button-small" onclick="confirm()">确认</button>


</div>
<script>
    var index = parent.layer.getFrameIndex(window.name); //获取窗口索引

    function del()
    {
        parent.inputCsajax("del", GetQuery('id'));
        parent.layer.close(index);
        //window.returnValue = "del";
        //window.close();
    }
    function cancel() {
        self.close();
    }
    function confirm() {
        var _Descripe = String($("#Descripe").val());
        var _ResponseBy = String($("#ResponseBy").val());
        var _Action = String($("#Action").val());
        var _PlanDate = String($("#PlanDate").val());
        var _IsRapid = String($("#IsRapid").val());

        if (_Descripe == "" || _ResponseBy == "" || _PlanDate=="")
        {
            alert("请填写完整项目再提交");
            return false;
        }
        var durl = encodeURI('@Url.Action("InsertAction", "Plan")?problem=' + _Descripe + '&action1=' + _Action + '&response=' + _ResponseBy + '&plandate=' + _PlanDate + '&IsRapid=' + _IsRapid + '&plandid=' + GetQuery('plandid'));
        $.ajax({
            type: "post",
            url: durl,
            async: false,
            success: function (msg) {
                if (msg > 0) {
                    alert("更新成功");
                }
                else {
                    alert("出错了！");
                }
            },
            error: function () {
                alert("出错了");
            }
        });


        parent.inputCsajax(1, GetQuery('id'));
        parent.layer.close(index);
        //window.returnValue = 1;
        //window.close();
    }
    function BindEvent()
    {



        $("#ResponseBy").html("");

        $("#ResponseBy").append("<option value=''>==请选择==</option>");
        AjaxJson("/FYModule/Plan/ResponseAllJson", {}, function (DataJson) {
            $.each(DataJson, function (i) {
                $("#ResponseBy").append($("<option></option>").val(DataJson[i].UserId).html(DataJson[i].RealName));
            });
        })
    }

    var temp;

    $(document).ready(function () {
        BindEvent();
       temp=$("#ResponseBy").select2();
        
    })

    function CheckIsManger() {
       // alert(11);
        var _ResponseBy = String($("#ResponseBy").val());
        var durl = encodeURI('@Url.Action("CheckIsManager", "Plan")');
        $.ajax({
            type: "post",
            url: durl,
            data: { ResponseBy: _ResponseBy },
            async: false,
            success: function (msg) {
                if (msg == 0) {
                    alert("您需要选择车间班长及以上的人员");
                    $("#ResponseBy").val("");
                    $("#ResponseBy").select2();
                    //$("#dataClearCorrect_type").val("").trigger("change");
                    //temp.val("").trigger("change");
                    //temp.change();
                    return false;
                }
                else if (msg == 1)
                {}
                else {
                    alert("未知错误，请联系管理员！");
                }
            },
            error: function () {
                alert("出错了");
            }
        });
    }
   //window.onload = BindEvent();
</script>
